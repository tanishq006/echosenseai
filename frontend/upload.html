<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Audio | ECHOSENSE AI</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #ffffff;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 20px 8%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        header h1 {
            font-size: 1.6rem;
            font-weight: 800;
            background: linear-gradient(135deg, #0077ff 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        nav a {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        nav a:hover,
        nav a.active {
            color: #0077ff;
        }

        /* Main Content */
        main {
            padding: 120px 8% 60px;
            max-width: 900px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 50px;
            font-size: 1.1rem;
            text-align: center;
        }

        /* Upload Container */
        .upload-container {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.8) 0%, rgba(30, 30, 30, 0.6) 100%);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .upload-container.dragover {
            border-color: #0077ff;
            background: linear-gradient(135deg, rgba(0, 119, 255, 0.1) 0%, rgba(0, 212, 255, 0.1) 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #0077ff;
            margin-bottom: 20px;
        }

        .upload-container h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .upload-container p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 25px;
        }

        .file-input {
            display: none;
        }

        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #0077ff 0%, #0055cc 100%);
            color: #fff;
            padding: 12px 30px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 119, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* File Info */
        .file-info {
            display: none;
            background: rgba(0, 119, 255, 0.1);
            border: 1px solid rgba(0, 119, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .file-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .file-actions {
            display: flex;
            gap: 15px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: none;
        }

        /* Progress */
        .progress-container {
            display: none;
            margin-top: 30px;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #0077ff, #00d4ff);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-align: center;
        }

        /* Processing Stages */
        .processing-stages {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .processing-stages.show {
            display: block;
        }

        .stage {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            opacity: 0.4;
            transition: all 0.3s ease;
        }

        .stage.active {
            opacity: 1;
        }

        .stage.completed {
            opacity: 0.7;
        }

        .stage-icon {
            font-size: 1.5rem;
            min-width: 30px;
            text-align: center;
        }

        .stage.active .stage-icon {
            color: #0077ff;
            animation: pulse 2s ease-in-out infinite;
        }

        .stage.completed .stage-icon {
            color: #22c55e;
        }

        .stage-text {
            flex: 1;
            font-size: 0.95rem;
        }

        .stage-text .stage-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 3px;
        }

        .stage-text .stage-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* Success/Error Messages */
        .message {
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .message-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .message h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .message p {
            margin-bottom: 15px;
        }

        /* Supported Formats */
        .supported-formats {
            margin-top: 40px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .supported-formats h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
        }

        .format-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .format-tag {
            background: rgba(0, 119, 255, 0.1);
            border: 1px solid rgba(0, 119, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #0077ff;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }

            .upload-container {
                padding: 40px 25px;
            }

            main {
                padding: 100px 5% 40px;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>ECHOSENSE AI</h1>
        <nav>
            <a href="dashboard.html">Dashboard</a>
            <a href="upload.html" class="active">Upload</a>
            <a href="index.html">Home</a>
        </nav>
    </header>

    <main>
        <h1 class="page-title">Upload Audio File</h1>
        <p class="page-subtitle">Upload a call recording for AI-powered analysis</p>

        <div class="upload-container" id="uploadContainer">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h2>Drag & Drop Audio File</h2>
            <p>or click to browse your files</p>
            <button class="btn" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-folder-open"></i> Browse Files
            </button>
            <input type="file" id="fileInput" class="file-input" accept=".mp3,.wav,.m4a,.ogg,.flac">
        </div>

        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-details" id="fileDetails"></div>
            <div class="file-actions">
                <button class="btn" id="uploadBtn">
                    <i class="fas fa-upload"></i> Upload & Analyze
                </button>
                <button class="btn btn-secondary" id="cancelBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">Uploading...</div>
        </div>

        <div class="processing-stages" id="processingStages">
            <div class="stage" id="stageUpload">
                <div class="stage-icon">
                    <i class="fas fa-upload"></i>
                </div>
                <div class="stage-text">
                    <div class="stage-title">Upload Complete</div>
                    <div class="stage-desc">Audio file uploaded successfully</div>
                </div>
            </div>
            <div class="stage" id="stageProcessing">
                <div class="stage-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stage-text">
                    <div class="stage-title">Processing</div>
                    <div class="stage-desc">Analyzing call recording...</div>
                </div>
            </div>
            <div class="stage" id="stageComplete">
                <div class="stage-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stage-text">
                    <div class="stage-title">Analysis Complete</div>
                    <div class="stage-desc">Preparing your results...</div>
                </div>
            </div>
        </div>

        <div class="message" id="messageContainer">
            <div class="message-icon" id="messageIcon"></div>
            const uploadContainer = document.getElementById('uploadContainer');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileDetails = document.getElementById('fileDetails');
            const uploadBtn = document.getElementById('uploadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const messageContainer = document.getElementById('messageContainer');

            // Drag and drop handlers
            uploadContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadContainer.classList.add('dragover');
            });

            uploadContainer.addEventListener('dragleave', () => {
            uploadContainer.classList.remove('dragover');
            });

            uploadContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadContainer.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
            handleFileSelect(files[0]);
            }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
            }
            });

            // Handle file selection
            function handleFileSelect(file) {
            // Validate file type
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/flac'];
            const allowedExtensions = ['.mp3', '.wav', '.m4a', '.ogg', '.flac'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedExtensions.includes(fileExtension)) {
            showMessage('error', 'Invalid File Type', 'Please upload an audio file (MP3, WAV, M4A, OGG, or FLAC)');
            return;
            }

            // Validate file size (100MB)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
            showMessage('error', 'File Too Large', 'Maximum file size is 100MB. Please upload a smaller file.');
            return;
            }

            selectedFile = file;

            // Display file info
            fileName.textContent = file.name;
            fileDetails.innerHTML = `
            <i class="fas fa-file-audio"></i> ${formatFileSize(file.size)} •
            <i class="fas fa-calendar"></i> ${new Date(file.lastModified).toLocaleDateString()}
            `;

            fileInfo.classList.add('show');
            messageContainer.classList.remove('show');
            }

            // Upload button
            uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            uploadBtn.disabled = true;
            cancelBtn.disabled = true;
            progressContainer.classList.add('show');
            messageContainer.classList.remove('show');

            try {
            // Simulate progress (since fetch doesn't provide upload progress easily)
            let progress = 0;
            const progressInterval = setInterval(() => {
            progress += 10;
            if (progress <= 90) { progressBar.style.width=progress + '%' ; } }, 200); // Upload file const result=await
                api.uploadAudio(selectedFile); clearInterval(progressInterval); progressBar.style.width='100%' ;
                progressText.textContent='Upload complete! Starting analysis...' ; // Show processing stages
                document.getElementById('processingStages').classList.add('show');
                document.getElementById('stageUpload').classList.add('completed'); // Start polling for processing
                status await pollProcessingStatus(result.call_id); } catch (error) { console.error('Upload error:',
                error); showMessage('error', 'Upload Failed' , error.message
                || 'An error occurred during upload. Please try again.' ); progressContainer.classList.remove('show');
                uploadBtn.disabled=false; cancelBtn.disabled=false; } }); // Cancel button
                cancelBtn.addEventListener('click', ()=> {
                selectedFile = null;
                fileInput.value = '';
                fileInfo.classList.remove('show');
                messageContainer.classList.remove('show');
                progressContainer.classList.remove('show');
                document.getElementById('processingStages').classList.remove('show');
                resetStages();
                uploadBtn.disabled = false;
                cancelBtn.disabled = false;
                });

                // Helper functions
                function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }

                function showMessage(type, title, text, actionText = null, actionLink = null) {
                const messageIcon = document.getElementById('messageIcon');
                const messageTitle = document.getElementById('messageTitle');
                const messageText = document.getElementById('messageText');
                const messageAction = document.getElementById('messageAction');

                messageContainer.className = 'message show ' + type;
                messageIcon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i
                    class="fas fa-exclamation-circle"></i>';
                messageTitle.textContent = title;
                messageText.textContent = text;

                if (actionText && actionLink) {
                messageAction.textContent = actionText;
                messageAction.href = actionLink;
                messageAction.style.display = 'inline-block';
                } else {
                messageAction.style.display = 'none';
                }
                }

                // Poll processing status
                async function pollProcessingStatus(callId) {
                const maxAttempts = 60; // 2 minutes max (60 * 2 seconds)
                let attempts = 0;

                const stageUpload = document.getElementById('stageUpload');
                const stageProcessing = document.getElementById('stageProcessing');
                const stageComplete = document.getElementById('stageComplete');

                return new Promise((resolve, reject) => {
                const pollInterval = setInterval(async () => {
                attempts++;

                try {
                const status = await api.getProcessingStatus(callId);

                if (status.status === 'processing') {
                // Update progress
                progressBar.style.width = '60%';
                progressText.textContent = 'Analyzing call recording...';
                stageProcessing.classList.add('active');

                } else if (status.status === 'completed') {
                // Processing complete
                clearInterval(pollInterval);
                progressBar.style.width = '100%';
                progressText.textContent = 'Analysis complete!';

                stageProcessing.classList.remove('active');
                stageProcessing.classList.add('completed');
                stageComplete.classList.add('completed');

                // Navigate to call details after short delay
                setTimeout(() => {
                window.location.href = `call-details.html?id=${callId}`;
                }, 1500);

                resolve();

                } else if (status.status === 'failed') {
                // Processing failed
                clearInterval(pollInterval);
                showMessage('error', 'Processing Failed', status.error_message || 'An error occurred during analysis.');

                // Reset UI
                progressContainer.classList.remove('show');
                document.getElementById('processingStages').classList.remove('show');
                resetStages();
                uploadBtn.disabled = false;
                cancelBtn.disabled = false;

                reject(new Error(status.error_message));
                // Continue polling on individual request errors
                const cancelBtn = document.getElementById('cancelBtn');
                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const messageContainer = document.getElementById('messageContainer');

                // Drag and drop handlers
                uploadContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadContainer.classList.add('dragover');
                });

                uploadContainer.addEventListener('dragleave', () => {
                uploadContainer.classList.remove('dragover');
                });

                uploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadContainer.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                handleFileSelect(files[0]);
                }
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
                }
                });

                // Handle file selection
                function handleFileSelect(file) {
                // Validate file type
                const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/flac'];
                const allowedExtensions = ['.mp3', '.wav', '.m4a', '.ogg', '.flac'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                if (!allowedExtensions.includes(fileExtension)) {
                showMessage('error', 'Invalid File Type', 'Please upload an audio file (MP3, WAV, M4A, OGG, or FLAC)');
                return;
                }

                // Validate file size (100MB)
                const maxSize = 100 * 1024 * 1024;
                if (file.size > maxSize) {
                showMessage('error', 'File Too Large', 'Maximum file size is 100MB. Please upload a smaller file.');
                return;
                }

                selectedFile = file;

                // Display file info
                fileName.textContent = file.name;
                fileDetails.innerHTML = `
                <i class="fas fa-file-audio"></i> ${formatFileSize(file.size)} •
                <i class="fas fa-calendar"></i> ${new Date(file.lastModified).toLocaleDateString()}
                `;

                fileInfo.classList.add('show');
                messageContainer.classList.remove('show');
                }

                // Upload button
                uploadBtn.addEventListener('click', async () => {
                if (!selectedFile) return;

                uploadBtn.disabled = true;
                cancelBtn.disabled = true;
                progressContainer.classList.add('show');
                messageContainer.classList.remove('show');

                try {
                // Simulate progress (since fetch doesn't provide upload progress easily)
                let progress = 0;
                const progressInterval = setInterval(() => {
                progress += 10;
                if (progress <= 90) { progressBar.style.width=progress + '%' ; } }, 200); // Upload file const
                    result=await api.uploadAudio(selectedFile); clearInterval(progressInterval);
                    progressBar.style.width='100%' ; progressText.textContent='Upload complete! Starting analysis...' ;
                    // Show processing stages document.getElementById('processingStages').classList.add('show');
                    document.getElementById('stageUpload').classList.add('completed'); // Start polling for processing
                    status await pollProcessingStatus(result.call_id); } catch (error) { console.error('Upload error:',
                    error); showMessage('error', 'Upload Failed' , error.message
                    || 'An error occurred during upload. Please try again.' );
                    progressContainer.classList.remove('show'); uploadBtn.disabled=false; cancelBtn.disabled=false; }
                    }); // Cancel button cancelBtn.addEventListener('click', ()=> {
                    selectedFile = null;
                    fileInput.value = '';
                    fileInfo.classList.remove('show');
                    messageContainer.classList.remove('show');
                    progressContainer.classList.remove('show');
                    document.getElementById('processingStages').classList.remove('show');
                    resetStages();
                    uploadBtn.disabled = false;
                    cancelBtn.disabled = false;
                    });

                    // Helper functions
                    function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                    }

                    function showMessage(type, title, text, actionText = null, actionLink = null) {
                    const messageIcon = document.getElementById('messageIcon');
                    const messageTitle = document.getElementById('messageTitle');
                    const messageText = document.getElementById('messageText');
                    const messageAction = document.getElementById('messageAction');

                    messageContainer.className = 'message show ' + type;
                    messageIcon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i
                        class="fas fa-exclamation-circle"></i>';
                    messageTitle.textContent = title;
                    messageText.textContent = text;

                    if (actionText && actionLink) {
                    messageAction.textContent = actionText;
                    messageAction.href = actionLink;
                    messageAction.style.display = 'inline-block';
                    } else {
                    messageAction.style.display = 'none';
                    }
                    }

                    // Poll processing status
                    async function pollProcessingStatus(callId) {
                    const maxAttempts = 60; // 2 minutes max (60 * 2 seconds)
                    let attempts = 0;

                    const stageUpload = document.getElementById('stageUpload');
                    const stageProcessing = document.getElementById('stageProcessing');
                    const stageComplete = document.getElementById('stageComplete');

                    return new Promise((resolve, reject) => {
                    const pollInterval = setInterval(async () => {
                    attempts++;

                    try {
                    const status = await api.getProcessingStatus(callId);

                    if (status.status === 'processing') {
                    // Update progress
                    progressBar.style.width = '60%';
                    progressText.textContent = 'Analyzing call recording...';
                    stageProcessing.classList.add('active');

                    } else if (status.status === 'completed') {
                    // Processing complete
                    clearInterval(pollInterval);
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Analysis complete!';

                    stageProcessing.classList.remove('active');
                    stageProcessing.classList.add('completed');
                    stageComplete.classList.add('completed');

                    // Navigate to call details after short delay
                    setTimeout(() => {
                    window.location.href = `call-details.html?id=${callId}`;
                    }, 1500);

                    resolve();

                    } else if (status.status === 'failed') {
                    // Processing failed
                    clearInterval(pollInterval);
                    showMessage('error', 'Processing Failed', status.error_message || 'An error occurred during
                    analysis.');

                    // Reset UI
                    progressContainer.classList.remove('show');
                    document.getElementById('processingStages').classList.remove('show');
                    resetStages();
                    uploadBtn.disabled = false;
                    cancelBtn.disabled = false;

                    reject(new Error(status.error_message));
                    }

                    // Timeout check
                    if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    showMessage('error', 'Processing Timeout', 'Analysis is taking longer than expected. Please check
                    the
                    call details page.');
                    reject(new Error('Polling timeout'));
                    }

                    } catch (error) {
                    console.error('Polling error:', error);
                    // Continue polling on individual request errors
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const messageContainer = document.getElementById('messageContainer');

                    // Drag and drop handlers
                    uploadContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadContainer.classList.add('dragover');
                    });

                    uploadContainer.addEventListener('dragleave', () => {
                    uploadContainer.classList.remove('dragover');
                    });

                    uploadContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadContainer.classList.remove('dragover');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                    handleFileSelect(files[0]);
                    }
                    });

                    // File input change
                    fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                    }
                    });

                    // Handle file selection
                    function handleFileSelect(file) {
                    // Validate file type
                    const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/flac'];
                    const allowedExtensions = ['.mp3', '.wav', '.m4a', '.ogg', '.flac'];
                    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                    if (!allowedExtensions.includes(fileExtension)) {
                    showMessage('error', 'Invalid File Type', 'Please upload an audio file (MP3, WAV, M4A, OGG, or
                    FLAC)');
                    return;
                    }

                    // Validate file size (100MB)
                    const maxSize = 100 * 1024 * 1024;
                    if (file.size > maxSize) {
                    showMessage('error', 'File Too Large', 'Maximum file size is 100MB. Please upload a smaller file.');
                    return;
                    }

                    selectedFile = file;

                    // Display file info
                    fileName.textContent = file.name;
                    fileDetails.innerHTML = `
                    <i class="fas fa-file-audio"></i> ${formatFileSize(file.size)} •
                    <i class="fas fa-calendar"></i> ${new Date(file.lastModified).toLocaleDateString()}
                    `;

                    fileInfo.classList.add('show');
                    messageContainer.classList.remove('show');
                    }

                    // Upload button
                    uploadBtn.addEventListener('click', async () => {
                    if (!selectedFile) return;

                    uploadBtn.disabled = true;
                    cancelBtn.disabled = true;
                    progressContainer.classList.add('show');
                    messageContainer.classList.remove('show');

                    try {
                    // Simulate progress (since fetch doesn't provide upload progress easily)
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) { progressBar.style.width=progress + '%' ; } }, 200); // Upload file const
                        result=await api.uploadAudio(selectedFile); clearInterval(progressInterval);
                        progressBar.style.width='100%' ;
                        progressText.textContent='Upload complete! Starting analysis...' ; // Show processing stages
                        document.getElementById('processingStages').classList.add('show');
                        document.getElementById('stageUpload').classList.add('completed'); // Start polling for
                        processing status await pollProcessingStatus(result.call_id); } catch (error) {
                        console.error('Upload error:', error); showMessage('error', 'Upload Failed' , error.message
                        || 'An error occurred during upload. Please try again.' );
                        progressContainer.classList.remove('show'); uploadBtn.disabled=false; cancelBtn.disabled=false;
                        } }); // Cancel button cancelBtn.addEventListener('click', ()=> {
                        selectedFile = null;
                        fileInput.value = '';
                        fileInfo.classList.remove('show');
                        messageContainer.classList.remove('show');
                        progressContainer.classList.remove('show');
                        document.getElementById('processingStages').classList.remove('show');
                        resetStages();
                        uploadBtn.disabled = false;
                        cancelBtn.disabled = false;
                        });

                        // Helper functions
                        function formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                        }

                        function showMessage(type, title, text, actionText = null, actionLink = null) {
                        const messageIcon = document.getElementById('messageIcon');
                        const messageTitle = document.getElementById('messageTitle');
                        const messageText = document.getElementById('messageText');
                        const messageAction = document.getElementById('messageAction');

                        messageContainer.className = 'message show ' + type;
                        messageIcon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i
                            class="fas fa-exclamation-circle"></i>';
                        messageTitle.textContent = title;
                        messageText.textContent = text;

                        if (actionText && actionLink) {
                        messageAction.textContent = actionText;
                        messageAction.href = actionLink;
                        messageAction.style.display = 'inline-block';
                        } else {
                        messageAction.style.display = 'none';
                        }
                        }

                        // Poll processing status
                        async function pollProcessingStatus(callId) {
                        const maxAttempts = 60; // 2 minutes max (60 * 2 seconds)
                        let attempts = 0;

                        const stageUpload = document.getElementById('stageUpload');
                        const stageProcessing = document.getElementById('stageProcessing');
                        const stageComplete = document.getElementById('stageComplete');

                        return new Promise((resolve, reject) => {
                        const pollInterval = setInterval(async () => {
                        attempts++;

                        try {
                        const status = await api.getProcessingStatus(callId);

                        if (status.status === 'processing') {
                        // Update progress
                        progressBar.style.width = '60%';
                        progressText.textContent = 'Analyzing call recording...';
                        stageProcessing.classList.add('active');

                        } else if (status.status === 'completed') {
                        // Processing complete
                        clearInterval(pollInterval);
                        progressBar.style.width = '100%';
                        progressText.textContent = 'Analysis complete!';

                        stageProcessing.classList.remove('active');
                        stageProcessing.classList.add('completed');
                        stageComplete.classList.add('completed');

                        // Navigate to call details after short delay
                        setTimeout(() => {
                        window.location.href = `call-details.html?id=${callId}`;
                        }, 1500);

                        resolve();

                        } else if (status.status === 'failed') {
                        // Processing failed
                        clearInterval(pollInterval);
                        showMessage('error', 'Processing Failed', status.error_message || 'An error occurred during
                        analysis.');

                        // Reset UI
                        progressContainer.classList.remove('show');
                        document.getElementById('processingStages').classList.remove('show');
                        resetStages();
                        uploadBtn.disabled = false;
                        cancelBtn.disabled = false;

                        reject(new Error(status.error_message));
                        }

                        // Timeout check
                        if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        showMessage('error', 'Processing Timeout', 'Analysis is taking longer than expected. Please
                        check
                        the
                        call details page.');
                        reject(new Error('Polling timeout'));
                        }

                        } catch (error) {
                        console.error('Polling error:', error);
                        // Continue polling on individual request errors
                        // Drag and drop handlers
                        uploadContainer.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadContainer.classList.add('dragover');
                        });

                        uploadContainer.addEventListener('dragleave', () => {
                        uploadContainer.classList.remove('dragover');
                        });

                        uploadContainer.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadContainer.classList.remove('dragover');

                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                        handleFileSelect(files[0]);
                        }
                        });

                        // File input change
                        fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                        handleFileSelect(e.target.files[0]);
                        }
                        });

                        // Handle file selection
                        function handleFileSelect(file) {
                        // Validate file type
                        const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/flac'];
                        const allowedExtensions = ['.mp3', '.wav', '.m4a', '.ogg', '.flac'];
                        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                        if (!allowedExtensions.includes(fileExtension)) {
                        showMessage('error', 'Invalid File Type', 'Please upload an audio file (MP3, WAV, M4A, OGG, or
                        FLAC)');
                        return;
                        }

                        // Validate file size (100MB)
                        const maxSize = 100 * 1024 * 1024;
                        if (file.size > maxSize) {
                        showMessage('error', 'File Too Large', 'Maximum file size is 100MB. Please upload a smaller
                        file.');
                        return;
                        }

                        selectedFile = file;

                        // Display file info
                        fileName.textContent = file.name;
                        fileDetails.innerHTML = `
                        <i class="fas fa-file-audio"></i> ${formatFileSize(file.size)} •
                        <i class="fas fa-calendar"></i> ${new Date(file.lastModified).toLocaleDateString()}
                        `;

                        fileInfo.classList.add('show');
                        messageContainer.classList.remove('show');
                        }

                        // Upload button
                        uploadBtn.addEventListener('click', async () => {
                        if (!selectedFile) return;

                        uploadBtn.disabled = true;
                        cancelBtn.disabled = true;
                        progressContainer.classList.add('show');
                        messageContainer.classList.remove('show');

                        try {
                        // Simulate progress (since fetch doesn't provide upload progress easily)
                        let progress = 0;
                        const progressInterval = setInterval(() => {
                        progress += 10;
                        if (progress <= 90) { progressBar.style.width=progress + '%' ; } }, 200); // Upload file const
                            result=await api.uploadAudio(selectedFile); clearInterval(progressInterval);
                            progressBar.style.width='100%' ;
                            progressText.textContent='Upload complete! Starting analysis...' ; // Show processing stages
                            document.getElementById('processingStages').classList.add('show');
                            document.getElementById('stageUpload').classList.add('completed'); // Start polling for
                            processing status await pollProcessingStatus(result.call_id); } catch (error) {
                            console.error('Upload error:', error); showMessage('error', 'Upload Failed' , error.message
                            || 'An error occurred during upload. Please try again.' );
                            progressContainer.classList.remove('show'); uploadBtn.disabled=false;
                            cancelBtn.disabled=false; } }); // Cancel button cancelBtn.addEventListener('click', ()=> {
                            selectedFile = null;
                            fileInput.value = '';
                            fileInfo.classList.remove('show');
                            messageContainer.classList.remove('show');
                            progressContainer.classList.remove('show');
                            document.getElementById('processingStages').classList.remove('show');
                            resetStages();
                            uploadBtn.disabled = false;
                            cancelBtn.disabled = false;
                            });

                            // Helper functions
                            function formatFileSize(bytes) {
                            if (bytes === 0) return '0 Bytes';
                            const k = 1024;
                            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                            }

                            function showMessage(type, title, text, actionText = null, actionLink = null) {
                            const messageIcon = document.getElementById('messageIcon');
                            const messageTitle = document.getElementById('messageTitle');
                            const messageText = document.getElementById('messageText');
                            const messageAction = document.getElementById('messageAction');

                            messageContainer.className = 'message show ' + type;
                            messageIcon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i
                                class="fas fa-exclamation-circle"></i>';
                            messageTitle.textContent = title;
                            messageText.textContent = text;

                            if (actionText && actionLink) {
                            messageAction.textContent = actionText;
                            messageAction.href = actionLink;
                            messageAction.style.display = 'inline-block';
                            } else {
                            messageAction.style.display = 'none';
                            }
                            }

                            // Poll processing status
                            async function pollProcessingStatus(callId) {
                            const maxAttempts = 60; // 2 minutes max (60 * 2 seconds)
                            let attempts = 0;

                            const stageUpload = document.getElementById('stageUpload');
                            const stageProcessing = document.getElementById('stageProcessing');
                            const stageComplete = document.getElementById('stageComplete');

                            return new Promise((resolve, reject) => {
                            const pollInterval = setInterval(async () => {
                            attempts++;

                            try {
                            const status = await api.getProcessingStatus(callId);

                            if (status.status === 'processing') {
                            // Update progress
                            progressBar.style.width = '60%';
                            progressText.textContent = 'Analyzing call recording...';
                            stageProcessing.classList.add('active');

                            } else if (status.status === 'completed') {
                            // Processing complete
                            clearInterval(pollInterval);
                            progressBar.style.width = '100%';
                            progressText.textContent = 'Analysis complete!';

                            stageProcessing.classList.remove('active');
                            stageProcessing.classList.add('completed');
                            stageComplete.classList.add('completed');

                            // Navigate to call details after short delay
                            setTimeout(() => {
                            window.location.href = `call-details.html?id=${callId}`;
                            }, 1500);

                            resolve();

                            } else if (status.status === 'failed') {
                            // Processing failed
                            clearInterval(pollInterval);
                            showMessage('error', 'Processing Failed', status.error_message || 'An error occurred during
                            analysis.');

                            // Reset UI
                            progressContainer.classList.remove('show');
                            document.getElementById('processingStages').classList.remove('show');
                            resetStages();
                            uploadBtn.disabled = false;
                            cancelBtn.disabled = false;

                            reject(new Error(status.error_message));
                            }

                            // Timeout check
                            if (attempts >= maxAttempts) {
                            clearInterval(pollInterval);
                            showMessage('error', 'Processing Timeout', 'Analysis is taking longer than expected. Please
                            check
                            the
                            call details page.');
                            reject(new Error('Polling timeout'));
                            }

                            } catch (error) {
                            console.error('Polling error:', error);
                            // Continue polling on individual request errors
                            // Drag and drop handlers
                            uploadContainer.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            uploadContainer.classList.add('dragover');
                            });

                            uploadContainer.addEventListener('dragleave', () => {
                            uploadContainer.classList.remove('dragover');
                            });

                            uploadContainer.addEventListener('drop', (e) => {
                            e.preventDefault();
                            uploadContainer.classList.remove('dragover');

                            const files = e.dataTransfer.files;
                            if (files.length > 0) {
                            handleFileSelect(files[0]);
                            }
                            });

                            // File input change
                            fileInput.addEventListener('change', (e) => {
                            if (e.target.files.length > 0) {
                            handleFileSelect(e.target.files[0]);
                            }
                            });

                            // Handle file selection
                            function handleFileSelect(file) {
                            // Validate file type
                            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/flac'];
                            const allowedExtensions = ['.mp3', '.wav', '.m4a', '.ogg', '.flac'];
                            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                            if (!allowedExtensions.includes(fileExtension)) {
                            showMessage('error', 'Invalid File Type', 'Please upload an audio file (MP3, WAV, M4A, OGG,
                            or
                            FLAC)');
                            return;
                            }

                            // Validate file size (100MB)
                            const maxSize = 100 * 1024 * 1024;
                            if (file.size > maxSize) {
                            showMessage('error', 'File Too Large', 'Maximum file size is 100MB. Please upload a smaller
                            file.');
                            return;
                            }

                            selectedFile = file;

                            // Display file info
                            fileName.textContent = file.name;
                            fileDetails.innerHTML = `
                            <i class="fas fa-file-audio"></i> ${formatFileSize(file.size)} •
                            <i class="fas fa-calendar"></i> ${new Date(file.lastModified).toLocaleDateString()}
                            `;

                            fileInfo.classList.add('show');
                            messageContainer.classList.remove('show');
                            }

                            // Upload button
                            uploadBtn.addEventListener('click', async () => {
                            if (!selectedFile) return;

                            uploadBtn.disabled = true;
                            cancelBtn.disabled = true;
                            progressContainer.classList.add('show');
                            messageContainer.classList.remove('show');

                            try {
                            // Simulate progress (since fetch doesn't provide upload progress easily)
                            let progress = 0;
                            const progressInterval = setInterval(() => {
                            progress += 10;
                            if (progress <= 90) { progressBar.style.width=progress + '%' ; } }, 200); // Upload file
                                const result=await api.uploadAudio(selectedFile); clearInterval(progressInterval);
                                progressBar.style.width='100%' ;
                                progressText.textContent='Upload complete! Starting analysis...' ; // Show processing
                                stages document.getElementById('processingStages').classList.add('show');
                                document.getElementById('stageUpload').classList.add('completed'); // Start polling for
                                processing status await pollProcessingStatus(result.call_id); } catch (error) {
                                console.error('Upload error:', error); showMessage('error', 'Upload Failed' ,
                                error.message || 'An error occurred during upload. Please try again.' );
                                progressContainer.classList.remove('show'); uploadBtn.disabled=false;
                                cancelBtn.disabled=false; } }); // Cancel button cancelBtn.addEventListener('click',
                                ()=> {
                                selectedFile = null;
                                fileInput.value = '';
                                fileInfo.classList.remove('show');
                                messageContainer.classList.remove('show');
                                progressContainer.classList.remove('show');
                                document.getElementById('processingStages').classList.remove('show');
                                resetStages();
                                uploadBtn.disabled = false;
                                cancelBtn.disabled = false;
                                });

                                // Helper functions
                                function formatFileSize(bytes) {
                                if (bytes === 0) return '0 Bytes';
                                const k = 1024;
                                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                                const i = Math.floor(Math.log(bytes) / Math.log(k));
                                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                                }

                                function showMessage(type, title, text, actionText = null, actionLink = null) {
                                const messageIcon = document.getElementById('messageIcon');
                                const messageTitle = document.getElementById('messageTitle');
                                const messageText = document.getElementById('messageText');
                                const messageAction = document.getElementById('messageAction');

                                messageContainer.className = 'message show ' + type;
                                messageIcon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i
                                    class="fas fa-exclamation-circle"></i>';
                                messageTitle.textContent = title;
                                messageText.textContent = text;

                                if (actionText && actionLink) {
                                messageAction.textContent = actionText;
                                messageAction.href = actionLink;
                                messageAction.style.display = 'inline-block';
                                } else {
                                messageAction.style.display = 'none';
                                }
                                }

                                // Poll processing status
                                async function pollProcessingStatus(callId) {
                                const maxAttempts = 60; // 2 minutes max (60 * 2 seconds)
                                let attempts = 0;

                                const stageUpload = document.getElementById('stageUpload');
                                const stageProcessing = document.getElementById('stageProcessing');
                                const stageComplete = document.getElementById('stageComplete');

                                return new Promise((resolve, reject) => {
                                const pollInterval = setInterval(async () => {
                                attempts++;

                                try {
                                const status = await api.getProcessingStatus(callId);

                                if (status.status === 'processing') {
                                // Update progress
                                progressBar.style.width = '60%';
                                progressText.textContent = 'Analyzing call recording...';
                                stageProcessing.classList.add('active');

                                } else if (status.status === 'completed') {
                                // Processing complete
                                clearInterval(pollInterval);
                                progressBar.style.width = '100%';
                                progressText.textContent = 'Analysis complete!';

                                stageProcessing.classList.remove('active');
                                stageProcessing.classList.add('completed');
                                stageComplete.classList.add('completed');

                                // Navigate to call details after short delay
                                setTimeout(() => {
                                window.location.href = `call-details.html?id=${callId}`;
                                }, 1500);

                                resolve();

                                } else if (status.status === 'failed') {
                                // Processing failed
                                clearInterval(pollInterval);
                                showMessage('error', 'Processing Failed', status.error_message || 'An error occurred
                                during
                                analysis.');

                                // Reset UI
                                progressContainer.classList.remove('show');
                                document.getElementById('processingStages').classList.remove('show');
                                resetStages();
                                uploadBtn.disabled = false;
                                cancelBtn.disabled = false;

                                reject(new Error(status.error_message));
                                }

                                // Timeout check
                                if (attempts >= maxAttempts) {
                                clearInterval(pollInterval);
                                showMessage('error', 'Processing Timeout', 'Analysis is taking longer than expected.
                                Please
                                check
                                the
                                call details page.');
                                reject(new Error('Polling timeout'));
                                }

                                } catch (error) {
                                console.error('Polling error:', error);
                                // Continue polling on individual request errors
                                }
                                }, 2000); // Poll every 2 seconds
                                });
                                }

                                // Reset processing stages
                                function resetStages() {
                                const stages = document.querySelectorAll('.stage');
                                stages.forEach(stage => {
                                stage.classList.remove('active', 'completed');
                                });
                                }
                                </script>

</body>

</html>